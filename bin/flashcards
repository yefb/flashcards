#!/usr/bin/env ruby

require 'yaml'
require 'term/ansicolor'
require 'flashcards'

String.send(:include, Term::ANSIColor)

case ARGV.shift
when 'add', '+'
  unless ARGV.length == 2
    abort "Usage: #{$0} [word] [translation]"
  end

  load_do_then_save do |flashcards|
    unless flashcards.find { |flashcard| flashcard == Flashcard.new(expression: ARGV[0], translations: ARGV[1].split(',')) }
      flashcards << Flashcard.new(expression: ARGV[0], translations: ARGV[1].split(','))
    else
      warn "~ #{ARGV[1]} is already defined."
    end

    flashcards.map(&:data)
  end
when 'reset'
  load_do_then_save do |flashcards|
    flashcards.each { |flashcard| flashcard.metadata.clear }.map(&:data)
  end
when 'edit'
  editor = ARGV.shift || ENV['EDITOR'] || abort('Either configure $EDITOR or pass an editor as an argument.')
  exec "#{editor} #{FLASHCARDS_DATA.path}"
when 'stats'
  _load do |flashcards|
    puts colourise(<<-EOF, bold: true)
<red>Stats:</red>
  Total flashcards: #{flashcards.length}.
  You remember: #{flashcards.count { |flashcard| (flashcard.metadata[:correct_answers] || []).length > 2 }} (ones that you answered correctly 3 times or more).
  To be reviewed: #{flashcards.count(&:time_to_review?)}.
  Comletely new: #{flashcards.count(&:new?)}.
    EOF
  end
when '--help', '-h'
  puts(colourise(DATA.read))
when nil
  load_do_then_save do |flashcards|
    run(flashcards)

    # Save the metadata.
    flashcards.map(&:data)
  end
end

__END__

<red.bold>:: Flashcards ::</red.bold>

<cyan.bold>Commands</cyan.bold>

flashcards <red>add</red> [word] [translations]
flashcards <red>add</red> es todav√≠a still
flashcards <red>add</red> es case almost,nearly <bright_black># Add multiple translations.</bright_black>

flashcards <yellow>reset</yellow> <bright_black># Reset metadata.
  # Useful if you got someone else's file, and you want to reset his progress.</bright_black>

flashcards <green>edit</green> <bright_black># Edit your flashcards in $EDITOR.</bright_black>
flashcards <green>edit</green> vim

flashcards <bright_black># Run it!</bright_black>

<cyan.bold>ENV</cyan.bold>
  <magenta>FF</magenta>
    <bright_black># FF is short for flashcard file.
    # It defaults to ~/.config/flashcards.yml</bright_black>
    FF=~/.config/flashcards/es/swearwords.yml flashcards
